// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}



model User {
  id             String         @id @default(uuid())
  email          String         @unique
  passwordHash   String
  companyName    String?
  profilePicture String?
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  deletedAt      DateTime?

  sessions          Session[]
  validatedEntries  JournalEntry[] @relation("EntryValidator")
}

enum UserRole {
  ADMIN
  MANAGER
  USER
  VIEWER
}

model Session {
  id             String   @id @default(uuid())
  userId         String
  refreshToken   String   @unique
  expiresAt      DateTime
  revokedAt      DateTime?
  createdAt      DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model CompanyProfile {
  id             Int      @id @default(1)
  companyName    String
  companyEmail   String   @unique
  companyLogoUrl String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Person {
  id            String      @id @default(uuid())
  firstName     String
  lastName      String
  phone         String?
  email         String?     @unique
  address       String?
  church        String?
  isVisitor     Boolean     @default(false)
  isBorrower    Boolean     @default(false)
  isBuyer       Boolean     @default(false)
  isDonor       Boolean     @default(false)
  isSupplier    Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  deletedAt     DateTime?

  visits        VisitorLog[]
  loans         Loan[]
  sales         Sale[]
  purchases     Purchase[]
  donations     Donation[]
}

model VisitorLog {
  id           String   @id @default(uuid())
  personId     String?
  fullName     String?
  phone        String?
  email        String?
  address      String?
  church       String?
  visitDate    DateTime @default(now())
  notes        String?
  createdAt    DateTime @default(now())

  person Person? @relation(fields: [personId], references: [id], onDelete: SetNull)

  @@index([visitDate])
}

model Material {
  id             String           @id @default(uuid())
  type           MaterialType
  name           String
  reference      String?          @unique
  serialNumber   String?          @unique
  category       String?
  language       String?
  volume         String?
  status         MaterialStatus   @default(FUNCTIONAL)
  currentStock   Int              @default(0)
  minStockAlert  Int              @default(0)
  unitPrice      Decimal?
  sellingPrice   Decimal?
  location       String?
  description    String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  deletedAt      DateTime?

  stockMovements StockMovement[]
  loanItems      LoanItem[]
  saleItems      SaleItem[]
  purchaseItems  PurchaseItem[]
  donationItems  DonationItem[]
}

enum MaterialType {
  BOOK
  SD_CARD
  TABLET
  PHOTOCOPIER
  PRINTER
  CHAIR
  OTHER
}

enum MaterialStatus {
  FUNCTIONAL
  DEFECTIVE
  UNDER_REPAIR
  UNUSABLE
  LOST
  DONATED
}

model StockMovement {
  id             String            @id @default(uuid())
  materialId     String
  movementType   StockMovementType
  quantity       Int
  unitPrice      Decimal?
  totalAmount    Decimal?
  movementDate   DateTime          @default(now())
  description    String?
  reference      String?
  sourceType     SourceType?
  sourceId       String?
  createdAt      DateTime          @default(now())

  material Material @relation(fields: [materialId], references: [id], onDelete: Restrict)

  @@index([materialId])
  @@index([movementDate])
  @@index([sourceType, sourceId])
}

enum StockMovementType {
  PURCHASE_IN
  DONATION_IN
  DONATION_OUT
  LOAN_OUT
  RETURN_IN
  SALE_OUT
  ADJUSTMENT
  TRANSFER
  LOSS
}

model Loan {
  id               String      @id @default(uuid())
  personId         String
  borrowedAt       DateTime    @default(now())
  expectedReturnAt DateTime
  returnedAt       DateTime?
  status           LoanStatus  @default(ACTIVE)
  notes            String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  person Person    @relation(fields: [personId], references: [id], onDelete: Restrict)
  items  LoanItem[]

  @@index([personId])
  @@index([status])
}

model LoanItem {
  id          String   @id @default(uuid())
  loanId      String
  materialId  String
  quantity    Int      @default(1)
  createdAt   DateTime @default(now())

  loan      Loan     @relation(fields: [loanId], references: [id], onDelete: Cascade)
  material  Material @relation(fields: [materialId], references: [id], onDelete: Restrict)

  @@index([loanId])
  @@index([materialId])
}

enum LoanStatus {
  ACTIVE
  RETURNED
  OVERDUE
  LOST
}

model Sale {
  id             String        @id @default(uuid())
  personId       String?
  saleDate       DateTime      @default(now())
  paymentMethod  PaymentMethod
  paymentStatus  PaymentStatus @default(PAID)
  invoiceNumber  String?       @unique
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  person Person?   @relation(fields: [personId], references: [id], onDelete: SetNull)
  items  SaleItem[]

  @@index([saleDate])
  @@index([personId])
}

model SaleItem {
  id          String   @id @default(uuid())
  saleId      String
  materialId  String
  quantity    Int
  unitPrice   Decimal
  totalAmount Decimal
  createdAt   DateTime @default(now())

  sale     Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id], onDelete: Restrict)

  @@index([saleId])
  @@index([materialId])
}

model Purchase {
  id             String        @id @default(uuid())
  supplierId     String?
  purchaseDate   DateTime      @default(now())
  paymentMethod  PaymentMethod
  paymentStatus  PaymentStatus @default(PENDING)
  invoiceNumber  String?
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  supplier Person?        @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  items    PurchaseItem[]

  @@index([purchaseDate])
  @@index([supplierId])
}

model PurchaseItem {
  id          String   @id @default(uuid())
  purchaseId  String
  materialId  String
  quantity    Int
  unitPrice   Decimal
  totalAmount Decimal
  createdAt   DateTime @default(now())

  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id], onDelete: Restrict)

  @@index([purchaseId])
  @@index([materialId])
}

model Donation {
  id             String            @id @default(uuid())
  donorId        String?
  donorName      String?
  donorType      DonorType         @default(INDIVIDUAL)
  donationKind   DonationKind
  direction      DonationDirection  @default(IN)
  amount         Decimal?
  paymentMethod  PaymentMethod?
  donationDate   DateTime          @default(now())
  description    String?
  institution    String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  donor Person?        @relation(fields: [donorId], references: [id], onDelete: SetNull)
  items DonationItem[]

  @@index([donationDate])
  @@index([donorId])
}

model DonationItem {
  id          String   @id @default(uuid())
  donationId  String
  materialId  String
  quantity    Int
  createdAt   DateTime @default(now())

  donation Donation @relation(fields: [donationId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id], onDelete: Restrict)

  @@index([donationId])
  @@index([materialId])
}

enum DonationKind {
  FINANCIAL
  MATERIAL
}

enum DonationDirection {
  IN
  OUT
}

enum DonorType {
  INDIVIDUAL
  CORPORATE
  ASSOCIATION
  CHURCH
  OTHER
}

enum PaymentMethod {
  CASH
  CHECK
  BANK_TRANSFER
  CREDIT_CARD
  MOBILE_MONEY
  IN_KIND
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIALLY_PAID
  CANCELLED
  REFUNDED
}

model FiscalYear {
  id         String       @id @default(uuid())
  name       String       @unique
  startDate  DateTime
  endDate    DateTime
  isClosed   Boolean      @default(false)
  closedAt   DateTime?
  closedById String?
  createdAt  DateTime     @default(now())

  entries JournalEntry[]

  @@index([startDate, endDate])
}

model Account {
  id             String      @id @default(uuid())
  accountNumber  String      @unique
  name           String
  type           AccountType
  accountClass   Int
  isActive       Boolean     @default(true)
  isAnalytic     Boolean     @default(false)
  parentId       String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  parent   Account?       @relation("AccountHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Account[]      @relation("AccountHierarchy")
  lines    JournalLine[]

  @@index([accountClass])
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
  CONTINGENT
}

model JournalEntry {
  id             String        @id @default(uuid())
  entryNumber    String        @unique
  fiscalYearId   String
  date           DateTime
  journalType    JournalType
  pieceNumber    String?
  description    String
  sourceType     SourceType?
  sourceId       String?
  isValidated    Boolean       @default(false)
  validatedAt    DateTime?
  validatedById  String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  fiscalYear  FiscalYear   @relation(fields: [fiscalYearId], references: [id], onDelete: Restrict)
  validatedBy User?        @relation("EntryValidator", fields: [validatedById], references: [id], onDelete: SetNull)
  lines       JournalLine[]

  @@index([date])
  @@index([journalType])
  @@index([sourceType, sourceId])
}

model JournalLine {
  id          String   @id @default(uuid())
  entryId     String
  accountId   String
  debit       Decimal  @default(0)
  credit      Decimal  @default(0)
  description String?
  createdAt   DateTime @default(now())

  entry   JournalEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  account Account      @relation(fields: [accountId], references: [id], onDelete: Restrict)

  @@index([entryId])
  @@index([accountId])
}

enum JournalType {
  GENERAL
  CASH
  PURCHASE
  SALES
  BANK
}

enum SourceType {
  SALE
  PURCHASE
  DONATION_FINANCIAL
  DONATION_MATERIAL
  LOAN
  RETURN
  STOCK_ADJUSTMENT
  EXPENSE
  OTHER
}

model DeletedItem {
  id            String    @id @default(uuid())
  originalTable String
  originalId    String
  data          Json
  deletedAt     DateTime  @default(now())
  expiresAt     DateTime
  restoredAt    DateTime?
  restoredById  String?

  @@index([expiresAt])
  @@index([originalTable, originalId])
}
